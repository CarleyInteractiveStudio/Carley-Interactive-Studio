<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carley Interactive Studio</title>
  <link rel="stylesheet" href="estilos.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/main.js"></script>
</head>
<body>

  <!-- Paneles de feedback -->
  <div id="error-panel" class="oculto"></div>
  <div id="success-panel" class="oculto"></div>

  <!-- Header y navegación -->
  <header>
    <h1>Carley Interactive Studio</h1>
    <nav>
      <a href="#bienvenida">Inicio</a>
      <a href="#juegos">Juegos</a>
      <a href="#apoyo">Apóyanos</a>
      <a href="#contacto">Contacto</a>
    </nav>
    <button id="settings-btn" class="gear">⚙️</button>
    <div id="settings-menu" class="menu-oculto">
      <button id="back-btn">Atrás</button>
      <button id="login-btn">Iniciar sesión</button>
      <button id="register-btn">Crear cuenta</button>
      <!-- Cerrar sesión se inyecta dinámicamente -->
    </div>
  </header>

  <!-- Sección Bienvenida -->
  <section id="bienvenida">
    <h2>Bienvenido</h2>
    <p>
      Bienvenido a Carley Interactive Studio, donde la pasión por los videojuegos
      y la innovación se unen. Sumérgete en la acción con Fire at Will y
      The Battle of the Capsurers mientras desarrollamos nuestro motor propio:
      <strong>Creative Engine</strong>.
    </p>
  </section>

  <!-- Sección Juegos -->
  <section id="juegos">
    <h2>Juegos Destacados</h2>

    <!-- The Battle of the Capsurers -->
    <div class="juego">
      <img src="carley_foto_web/The Battle Of The Capsurers logo.png"
           alt="The Battle of the Capsurers" class="juego-img" />
      <h3>The Battle of the Capsurers</h3>
      <p>Juego FPS multijugador divertido y emocionante.</p>
      <div class="flex-center">
        <a href="#" class="boton-juego descargar"
           data-app="The Battle of the Capsurers">Descargar</a>
        <button class="boton-juego" onclick="toggleForm('form-battle')">
          Soporte
        </button>
      </div>
      <div id="form-battle" class="formulario-soporte">
        <form>
          <input type="email" name="email" placeholder="Tu correo" required />
          <textarea name="mensaje"
                    placeholder="Describe el problema o tu solicitud"
                    required></textarea>
          <button type="submit">Enviar reporte</button>
        </form>
      </div>
    </div>

    <!-- Fire at Will -->
    <div class="juego">
      <img src="carley_foto_web/para fire at will.png"
           alt="Fire at Will" class="juego-img" />
      <h3>Fire at Will</h3>
      <p>Battle Royale con modos intensos de combate.</p>
      <div class="flex-center">
        <a href="#" class="boton-juego descargar"
           data-app="Fire at Will">Descargar</a>
        <button class="boton-juego" onclick="toggleForm('form-fire')">
          Soporte
        </button>
      </div>
      <div id="form-fire" class="formulario-soporte">
        <form>
          <input type="email" name="email" placeholder="Tu correo" required />
          <textarea name="mensaje"
                    placeholder="Describe el problema o tu solicitud"
                    required></textarea>
          <button type="submit">Enviar reporte</button>
        </form>
      </div>
    </div>

    <!-- Creative Engine -->
    <div class="juego">
      <img src="imags/Creative Engine.png"
           alt="Creative Engine" class="juego-img" />
      <h3>Creative Engine</h3>
      <p>Motor para crear tus propios videojuegos. ¡Próximamente!</p>
      <div class="flex-center">
        <a href="#" class="boton-juego descargar"
           data-app="Creative Engine">Descargar</a>
        <button class="boton-juego" onclick="toggleForm('form-creative')">
          Soporte
        </button>
      </div>
      <div id="form-creative" class="formulario-soporte">
        <form>
          <input type="email" name="email" placeholder="Tu correo" required />
          <textarea name="mensaje"
                    placeholder="Describe el problema o tu solicitud"
                    required></textarea>
          <button type="submit">Enviar reporte</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Sección Apóyanos -->
  <section id="apoyo">
    <h2>Apóyanos ❤️</h2>
    <p>Tu apoyo nos impulsa a seguir creando experiencias increíbles.</p>
    <div id="donate-button-container">
      <div id="donate-button"></div>
      <script src="https://www.paypalobjects.com/donate/sdk/donate-sdk.js"
              charset="UTF-8"></script>
      <script>
        PayPal.Donation.Button({
          env: 'production',
          hosted_button_id: 'JZ4KM2VUD6AMQ',
          image: {
            src: 'https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif',
            alt: 'Donate with PayPal button',
            title: 'PayPal - The safer, easier way to pay online!'
          }
        }).render('#donate-button');
      </script>
    </div>
    <a href="https://whatsapp.com/channel/0029Vao9B2OJP21CsSXDHL20"
       class="boton-juego" target="_blank">
      Únete a nuestro canal de WhatsApp
    </a>
  </section>

  <!-- Sección Contacto -->
  <section id="contacto">
    <h2>Contacto 📧</h2>
    <p>¿Tienes ideas, preguntas o quieres colaborar? Envíanos un mensaje.</p>
  </section>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 Carley Interactive Studio</p>
  </footer>

  <!-- Modales de autenticación y recuperación -->
  <div id="modal-backdrop" class="modal-backdrop oculto"></div>

  <!-- Login Modal -->
  <div id="modal-login" class="modal oculto">
    <h3>Iniciar sesión</h3>
    <input id="login-email" type="email" placeholder="Email" required />
    <input id="login-password" type="password" placeholder="Contraseña" required />
    <button id="login-submit">Entrar</button>
    <a id="open-forgot">¿Olvidaste tu contraseña?</a>
  </div>

  <!-- Register Modal -->
  <div id="modal-register" class="modal oculto">
    <h3>Crear cuenta</h3>
    <input id="reg-username" type="text" placeholder="Nombre de usuario" required />
    <input id="reg-email" type="email" placeholder="Email" required />
    <input id="reg-password" type="password" placeholder="Contraseña" required />
    <input id="reg-confirm-password" type="password"
           placeholder="Confirmar contraseña" required />
    <input id="reg-phone" type="tel" placeholder="Teléfono (opcional)" />
    <button id="register-submit">Registrar y entrar</button>
  </div>

  <!-- Forgot Password Modal -->
  <div id="modal-forgot" class="modal oculto">
    <h3>Recuperar contraseña</h3>
    <input id="fog-email" type="email" placeholder="Email" required />
    <input id="fog-phone" type="tel" placeholder="Teléfono" />
    <button id="fog-request-code">Enviar código</button>
    <div id="fog-step2" class="oculto">
      <input id="fog-code" type="text" maxlength="8"
             placeholder="Código de 8 dígitos" />
      <button id="fog-verify-code">Verificar código</button>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="modal-change" class="modal oculto">
    <h3>Cambiar contraseña</h3>
    <input id="old-password" type="password"
           placeholder="Contraseña actual" required />
    <input id="new-password" type="password"
           placeholder="Nueva contraseña" required />
    <button id="change-password-btn">Actualizar contraseña</button>
  </div>

  <!-- Chat Carley Bot -->
  <div id="chat-widget" class="chat-widget oculto">
    <div class="chat-header">
      <img src="imags/Carley Bot.png" alt="Carley Bot" class="bot-avatar" />
      <span class="bot-name">Carley Bot</span>
      <button id="chat-close-btn" class="chat-close-btn">✖️</button>
    </div>
    <div class="chat-body" id="chat-messages"></div>
    <div class="chat-input">
      <input id="chat-input-field" type="text" placeholder="Escribe un mensaje..." />
      <button id="chat-send-btn">Enviar</button>
    </div>
  </div>
  <button id="chat-open-btn" class="chat-open-btn">💬</button>

  <script>
  // Inicializar Supabase
  const SUPABASE_URL = 'https://rblftfzbqllnuadqtufb.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJibGZ0ZnpicWxsbnVhZHF0dWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5NjQyMzQsImV4cCI6MjA2ODU0MDIzNH0.cH-KJG2k43dKQaVccQDkw7t6m0sf1zIOLWPADdmKLt8';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // UI panels
  const errorPanel   = document.getElementById('error-panel');
  const successPanel = document.getElementById('success-panel');
  function mostrarError(msg) {
    errorPanel.textContent = msg;
    errorPanel.classList.remove('oculto');
    setTimeout(() => errorPanel.classList.add('oculto'), 4000);
  }
  function mostrarExito(msg) {
    successPanel.textContent = msg;
    successPanel.classList.remove('oculto');
    setTimeout(() => successPanel.classList.add('oculto'), 4000);
  }

  // Modales y menú
  const settingsBtn  = document.getElementById('settings-btn');
  const settingsMenu = document.getElementById('settings-menu');
  const backDrop     = document.getElementById('modal-backdrop');
  const mLogin       = document.getElementById('modal-login');
  const mRegister    = document.getElementById('modal-register');
  const mForgot      = document.getElementById('modal-forgot');
  const mChange      = document.getElementById('modal-change');

  settingsBtn.onclick = () => {
    settingsMenu.style.display = settingsMenu.style.display === 'flex'
      ? 'none'
      : 'flex';
  };
  document.getElementById('back-btn').onclick = () => {
    settingsMenu.style.display = 'none';
  };
  function toggleModal(modal) {
    const hidden = modal.classList.contains('oculto');
    [modal, backDrop].forEach(el =>
      el.classList.toggle('oculto', !hidden)
    );
  }
  document.getElementById('login-btn').onclick    = () => toggleModal(mLogin);
  document.getElementById('register-btn').onclick = () => toggleModal(mRegister);
  backDrop.onclick = () =>
    [mLogin, mRegister, mForgot, mChange, backDrop]
      .forEach(el => el.classList.add('oculto'));

  // Botón Cerrar sesión dinámico
  const logoutBtn = document.createElement('button');
  logoutBtn.id          = 'logout-btn-menu';
  logoutBtn.textContent = 'Cerrar sesión';
  logoutBtn.classList.add('boton-juego');
  logoutBtn.style.display = 'none';
  settingsMenu.appendChild(logoutBtn);
  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    logoutBtn.style.display = 'none';
    document.getElementById('login-btn').style.display    = 'block';
    document.getElementById('register-btn').style.display = 'block';
    mostrarExito('Has cerrado sesión.');
  };

  // Mostrar opción de logout si ya hay sesión
  async function showLogoutOption() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      logoutBtn.style.display = 'inline-block';
      document.getElementById('login-btn').style.display    = 'none';
      document.getElementById('register-btn').style.display = 'none';
      // Ocultar correo en formularios de soporte
      document.querySelectorAll('.formulario-soporte input[type="email"]')
        .forEach(el => el.style.display = 'none');
    }
  }
  showLogoutOption();

  // Registro
  document.getElementById('register-submit').onclick = async () => {
    const username = document.getElementById('reg-username').value.trim();
    const email    = document.getElementById('reg-email').value.trim();
    const pass     = document.getElementById('reg-password').value;
    const confirm  = document.getElementById('reg-confirm-password').value;
    const phone    = document.getElementById('reg-phone').value.trim() || null;

    if (!username)
      return mostrarError('Nombre de usuario obligatorio.');
    if (pass !== confirm)
      return mostrarError('Las contraseñas no coinciden.');

    // Verificar existencia
    const { data: existingProfile, error: fetchError } = await supabase
      .from('profiles')
      .select('email')
      .eq('email', email)
      .single();

    if (fetchError && fetchError.code !== 'PGRST116') {
      console.error(fetchError);
      return mostrarError('Error al comprobar el correo.');
    }
    if (existingProfile)
      return mostrarError('Este correo ya está registrado.');

    // Crear en Auth
    const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
      email,
      password: pass,
      options: {
        data: { username, phone },
        emailRedirectTo: `${location.origin}/bienvenida.html`
      }
    });
    if (signUpError) {
      console.error(signUpError);
      return mostrarError(signUpError.message);
    }

    // Insertar perfil en table 'profiles'
    const { error: profileError } = await supabase
      .from('profiles')
      .insert([{ id: signUpData.user.id, email, username, phone }]);
    if (profileError) {
      console.error(profileError);
      return mostrarError('Error al crear tu perfil. Contacta soporte.');
    }

    toggleModal(mRegister);
    mostrarExito('¡Cuenta creada! Revisa tu correo para confirmar.');
  };

  // Login
  document.getElementById('login-submit').onclick = async () => {
    const email = document.getElementById('login-email').value.trim();
    const pass  = document.getElementById('login-password').value;

    const { data, error } = await supabase.auth.signInWithPassword({
      email, password: pass
    });
    if (error) return mostrarError('Inicio fallido: ' + error.message);

    toggleModal(mLogin);
    showLogoutOption();
    mostrarExito('Sesión iniciada.');
    // Notificar por correo
    fetch('/send-login-notice', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
  };

  // Recuperar contraseña
  document.getElementById('open-forgot').onclick = () => {
    toggleModal(mLogin);
    toggleModal(mForgot);
  };
  document.getElementById('fog-request-code').onclick = async () => {
    const email = document.getElementById('fog-email').value.trim();
    const phone = document.getElementById('fog-phone').value.trim();

    const { data: user } = await supabase
      .from('profiles')
      .select('id')
      .eq('email', email)
      .eq('phone', phone)
      .single();
    if (!user) return mostrarError('Email o teléfono no coinciden.');

    await fetch('/.netlify/functions/send-reset-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, phone })
    });
    document.getElementById('fog-step2').classList.remove('oculto');
    mostrarExito('Código enviado. Revisa tu correo/SMS.');
  };
  document.getElementById('fog-verify-code').onclick = async () => {
    const email = document.getElementById('fog-email').value.trim();
    const code  = document.getElementById('fog-code').value.trim();

    const res = await fetch('/.netlify/functions/verify-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, code })
    });
    const { valid } = await res.json();
    if (!valid) return mostrarError('Código incorrecto.');

    await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: location.origin + '/reset-password.html'
    });
    toggleModal(mForgot);
    mostrarExito('Revisa tu correo para cambiar tu contraseña.');
  };

  // Cambiar contraseña
  document.getElementById('change-password-btn').onclick = async () => {
    const oldPass = document.getElementById('old-password').value;
    const newPass = document.getElementById('new-password').value;
    const { data: { session } } = await supabase.auth.getSession();
    const email = session.user.email;

    const res = await supabase.auth.signInWithPassword({
      email, password: oldPass
    });
    if (res.error) return mostrarError('Contraseña actual incorrecta.');

    const change = await supabase.auth.updateUser({ password: newPass });
    if (change.error) return mostrarError('No se pudo cambiar la contraseña.');

    toggleModal(mChange);
    mostrarExito('Contraseña actualizada con éxito.');
  };

  // Descargas
  document.querySelectorAll('.descargar').forEach(btn => {
    btn.onclick = e => {
      e.preventDefault();
      alert('Próximamente disponibles en 2025.');
    };
  });

  // Formularios de soporte toggle
  function toggleForm(id) {
    document.getElementById(id).classList.toggle('mostrar');
  }

  // Chat Carley Bot
  const chatWidget = document.getElementById('chat-widget');
  const openBtn    = document.getElementById('chat-open-btn');
  const closeBtn   = document.getElementById('chat-close-btn');
  const sendBtn    = document.getElementById('chat-send-btn');
  const inputField = document.getElementById('chat-input-field');
  const messagesEl = document.getElementById('chat-messages');
  let respuestas   = [];

  openBtn.onclick  = () => chatWidget.classList.remove('oculto');
  closeBtn.onclick = () => chatWidget.classList.add('oculto');

  async function cargarRespuestas() {
    const res = await fetch('respuestas.json');
    return res.json();
  }
  async function initBot() {
    respuestas = await cargarRespuestas();
  }
  initBot();

  function appendMessage(text, isBot = false) {
    const msg = document.createElement('div');
    msg.className = isBot ? 'msg bot' : 'msg user';
    msg.textContent = text;
    messagesEl.appendChild(msg);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function mostrarBotonesRedes() {
    const html = `
      <div class="redes-botones">
        <a href="https://youtube.com/@carleyinteractivestudio?si=L4xipACppCy4u6-2" target="_blank">📺 YouTube</a>
        <a href="https://whatsapp.com/channel/0029Vao9B2OJP21CsSXDHL20" target="_blank">📱 WhatsApp</a>
        <a href="https://www.facebook.com/share/19Lb2KuphF/" target="_blank">📘 Facebook</a>
      </div>`;
    messagesEl.innerHTML += html;
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function obtenerRespuesta(txt) {
    const msg = txt.toLowerCase();
    for (const r of respuestas) {
      if (r.intents.some(i => msg.includes(i))) {
        return r.respuesta;
      }
    }
    return null;
  }

  sendBtn.onclick = () => {
    const text = inputField.value.trim();
    if (!text) return;
    appendMessage(text, false);
    inputField.value = '';
    setTimeout(() => {
      const resp = obtenerRespuesta(text);
      if (resp) {
        appendMessage(resp, true);
      } else {
        appendMessage('Lo siento, no entendí. Te dejo mis redes:', true);
        mostrarBotonesRedes();
      }
    }, 300);
  };

  inputField.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendBtn.click();
  });
  </script>
</body>
</html>